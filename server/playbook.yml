- name: Deploy 3sila-AI FastAPI Application to Oracle Cloud
  hosts: webservers
  become: yes
  vars:
    old_app_dir: /home/ubuntu/task-manager-deployment
    app_dir: /home/ubuntu/3sila-ai-deployment

  tasks:
    # ---------------------------------------------------------
    # 1. NETTOYAGE
    # ---------------------------------------------------------
    - name: 1.1 Stop and remove old task-manager containers
      community.docker.docker_compose_v2:
        project_src: "{{ old_app_dir }}"
        state: absent
      ignore_errors: yes 

    - name: 1.2 Remove old deployment directory
      file:
        path: "{{ old_app_dir }}"
        state: absent
      ignore_errors: yes

    # ---------------------------------------------------------
    # 2. INSTALLATION (NETTOYAGE + NOUVELLE INSTALLATION)
    # ---------------------------------------------------------
    
    # NOUVEAU : On supprime l'ancien Docker qui cause le conflit
    - name: 2.0 Remove conflicting legacy packages
      apt:
        name: ['docker.io', 'docker-doc', 'docker-compose', 'podman-docker', 'containerd', 'runc']
        state: absent

    - name: 2.1 Update apt cache
      apt:
        update_cache: yes
        # On force la mise à jour des miroirs
        cache_valid_time: 0 

    - name: 2.2 Install Curl
      apt:
        name: curl
        state: present

    - name: 2.3 Download Docker Official Install Script
      get_url:
        url: https://get.docker.com
        dest: /tmp/get-docker.sh
        mode: '0700'

    - name: 2.4 Run Docker Install Script
      command: sh /tmp/get-docker.sh

    # On s'assure que le plugin est là (même si le script le fait)
    - name: 2.5 Ensure Docker Compose Plugin is installed
      apt:
        name: docker-compose-plugin
        state: latest

    - name: 2.6 Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    # ---------------------------------------------------------
    # 3. PRÉPARATION DES FICHIERS
    # ---------------------------------------------------------
    - name: 3.1 Create deployment directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        mode: '0755'

    - name: 3.2 Create server subdirectory for .env
      file:
        path: "{{ app_dir }}/server"
        state: directory
        owner: ubuntu
        mode: '0755'

    - name: 3.3 Copy docker-compose.yml and .env
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: ubuntu
        mode: '0644'
      loop:
        - { src: 'docker-compose.yml', dest: '{{ app_dir }}/docker-compose.yml' }
        - { src: '.env', dest: '{{ app_dir }}/server/.env' }

    # ---------------------------------------------------------
    # 4. DÉPLOIEMENT
    # ---------------------------------------------------------
    - name: 4.1 Pull latest image from Docker Hub
      community.docker.docker_image:
        name: laktabnoureddine/3sila-ai:latest
        source: pull

    - name: 4.2 Start 3sila-AI application with Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        state: present
        pull: always